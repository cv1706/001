<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>åœ‹é“é‡Œç¨‹èˆ‡äº¤æµé“è¨ˆç®—å™¨</title>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; padding: 20px; max-width: 900px; margin: 0 auto; background-color: #f4f4f4; }
        h2 { text-align: center; color: #333; }
        
        .input-group { margin-bottom: 15px; display: flex; gap: 10px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        input { padding: 12px; flex: 1; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; }
        button { padding: 10px 25px; background-color: #007bff; color: white; border: none; cursor: pointer; border-radius: 4px; font-size: 16px; font-weight: bold; }
        button:hover { background-color: #0056b3; }
        
        /* ç‰ˆé¢é…ç½® */
        #container { display: flex; gap: 20px; height: 500px; margin-top: 20px; }
        #selection-panel { width: 35%; overflow-y: auto; background: white; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); padding: 10px; }
        #map { width: 65%; background-color: #eee; height: 100%; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* è·¯ç·šæŒ‰éˆ•æ¨£å¼ */
        .route-btn { display: block; width: 100%; padding: 12px; margin-bottom: 8px; background: #fff; border: 1px solid #ddd; text-align: left; cursor: pointer; border-radius: 5px; transition: all 0.2s; }
        .route-btn:hover { background: #f0f0f0; border-color: #aaa; }
        .route-btn.active { background: #e8f0fe; border-color: #007bff; color: #0056b3; border-left: 5px solid #007bff; }

        /* åˆ†æçµæœå€å¡Š */
        #analysis-result { margin-top: 20px; padding: 20px; background: #fff; border-left: 6px solid #28a745; display: none; border-radius: 5px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .result-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px; }
        .result-item { background: #f9f9f9; padding: 10px; border-radius: 5px; }
        .result-label { font-size: 0.9em; color: #666; font-weight: bold; }
        .result-value { font-size: 1.1em; color: #333; margin-top: 5px; }
        .highlight { color: #d9534f; font-weight: bold; font-size: 1.2em; }
        
        /* äº¤æµé“è³‡è¨Šæ¨£å¼ */
        .ic-info { margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px; }
        .ic-step { display: flex; align-items: flex-start; margin-bottom: 8px; }
        .ic-icon { min-width: 24px; color: #28a745; font-weight: bold; margin-right: 8px; }
        .ic-text { color: #555; line-height: 1.4; }
    </style>
</head>
<body>

    <h2>ğŸš— åœ‹é“é‡Œç¨‹èˆ‡äº¤æµé“æŸ¥è©¢</h2>
    
    <div class="input-group">
        <input type="text" id="start" placeholder="è«‹è¼¸å…¥èµ·é» (ä¾‹å¦‚: å°åŒ—101)">
        <input type="text" id="end" placeholder="è«‹è¼¸å…¥çµ‚é» (ä¾‹å¦‚: é«˜é›„ç«è»Šç«™)">
        <button onclick="calculateRoute()">æŸ¥è©¢è·¯ç·š</button>
    </div>

    <div id="analysis-result"></div>

    <div id="container">
        <div id="selection-panel">
            <p style="color:#666; text-align:center; margin-top: 20px;">è«‹å…ˆè¼¸å…¥åœ°é»ä¸¦æŸ¥è©¢...</p>
        </div>
        <div id="map"></div>
    </div>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCQsMxnmE1-3YCotbwGKkDhHiaPln8KwIQ&libraries=places"></script>

    <script>
        let map, directionsService, directionsRenderer;
        let allRoutes = [];

        function initMap() {
            const taiwan = { lat: 23.6978, lng: 120.9605 };
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 7,
                center: taiwan,
                mapTypeControl: false,
                streetViewControl: false
            });
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer();
            directionsRenderer.setMap(map);

            setupAutocomplete("start");
            setupAutocomplete("end");
        }

        function setupAutocomplete(elementId) {
            const input = document.getElementById(elementId);
            const options = {
                componentRestrictions: { country: "tw" },
                fields: ["formatted_address", "geometry", "name"],
            };
            new google.maps.places.Autocomplete(input, options);
        }

        function calculateRoute() {
            const start = document.getElementById("start").value;
            const end = document.getElementById("end").value;

            if (!start || !end) {
                alert("è«‹è¼¸å…¥èµ·é»å’Œçµ‚é»ï¼");
                return;
            }

            const request = {
                origin: start,
                destination: end,
                travelMode: 'DRIVING',
                provideRouteAlternatives: true,
                drivingOptions: {
                    departureTime: new Date(),
                    trafficModel: 'bestguess'
                }
            };

            directionsService.route(request, function(result, status) {
                if (status == 'OK') {
                    allRoutes = result.routes;
                    renderRouteList(result.routes);
                    selectRoute(0, result); // é è¨­é¸ç¬¬ä¸€æ¢
                } else {
                    handleError(status);
                }
            });
        }

        function handleError(status) {
            if (status === 'NOT_FOUND') alert('æ‰¾ä¸åˆ°åœ°é»ï¼Œè«‹å˜—è©¦è¼¸å…¥å®Œæ•´åœ°å€ã€‚');
            else if (status === 'ZERO_RESULTS') alert('ç„¡æ³•è¦åŠƒé–‹è»Šè·¯ç·šã€‚');
            else alert('æŸ¥è©¢å¤±æ•—: ' + status);
        }

        function renderRouteList(routes) {
            const panel = document.getElementById("selection-panel");
            panel.innerHTML = "<h3 style='margin-top:0; padding-bottom:10px; border-bottom:1px solid #eee;'>å»ºè­°è·¯ç·š</h3>";

            routes.forEach((route, index) => {
                const summary = route.summary; 
                const distance = route.legs[0].distance.text;
                const duration = route.legs[0].duration.text;

                const btn = document.createElement("button");
                btn.className = "route-btn";
                btn.innerHTML = `
                    <div style="font-weight:bold; font-size:1.1em;">è·¯ç·š ${index + 1}</div>
                    <div style="color:#666; font-size:0.9em;">${summary}</div>
                    <div style="margin-top:5px;">ç¸½é•·: ${distance} | æ™‚é–“: ${duration}</div>
                `;
                btn.onclick = () => selectRoute(index);
                panel.appendChild(btn);
            });
        }

        function selectRoute(index, resultObj = null) {
            if (!resultObj) {
                // å¦‚æœä¸æ˜¯ç¬¬ä¸€æ¬¡æŸ¥è©¢ï¼Œåªéœ€é‡ç¹ªè·¯ç·š
                directionsRenderer.setDirections({routes: allRoutes, request: {}, status: "OK"}); 
            } else {
                directionsRenderer.setDirections(resultObj);
            }
            directionsRenderer.setRouteIndex(index);
            
            document.querySelectorAll(".route-btn").forEach((btn, i) => {
                btn.classList.toggle("active", i === index);
            });

            analyzeHighwayDetails(allRoutes[index]);
        }

        // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹é‚è¼¯åœ¨æ­¤ â˜…â˜…â˜…
        function analyzeHighwayDetails(route) {
            const leg = route.legs[0];
            const steps = leg.steps;
            
            // 1. åŸºæœ¬æ•¸æ“š
            const totalDistanceText = leg.distance.text; // å…¨ç¨‹ç¸½è·é›¢ (ä¾‹å¦‚: "158 å…¬é‡Œ")
            const totalDurationText = leg.duration.text; // å…¨ç¨‹ç¸½æ™‚é–“
            
            let highwayDistanceVal = 0;
            let entryInstruction = null; // ä¸Šäº¤æµé“æŒ‡ç¤º
            let exitInstruction = null;  // ä¸‹äº¤æµé“æŒ‡ç¤º
            let isOnHighway = false;

            // å®šç¾©åœ‹é“é—œéµå­—
            const highwayRegex = /(åœ‹é“|é«˜é€Ÿå…¬è·¯|Freeway|System|Expressway)/i; 

            steps.forEach((step, i) => {
                // ç§»é™¤ HTML æ¨™ç±¤ä»¥å–å¾—ç´”æ–‡å­—æŒ‡ç¤º
                const rawInstruction = step.instructions;
                const cleanInstruction = rawInstruction.replace(/<[^>]*>/g, ""); 
                
                if (highwayRegex.test(cleanInstruction)) {
                    // --- é€²å…¥åœ‹é“ ---
                    if (!isOnHighway) {
                        isOnHighway = true;
                        // é€šå¸¸"ä¸Šäº¤æµé“"çš„æŒ‡ç¤ºæœƒåœ¨é€²å…¥åœ‹é“çš„é‚£ä¸€æ­¥ï¼Œæˆ–è€…å‰ä¸€æ­¥çš„"Merge onto..."
                        // æˆ‘å€‘æŠ“å–ç•¶å‰é€™ä¸€æ­¥çš„æŒ‡ç¤ºä½œç‚ºèµ·é»
                        entryInstruction = cleanInstruction;
                    }
                    
                    // ç´¯åŠ åœ‹é“é‡Œç¨‹
                    highwayDistanceVal += step.distance.value;
                    
                    // æŒçºŒæ›´æ–°"æœ€å¾Œä¸€å€‹åœ‹é“æ­¥é©Ÿ"ï¼Œé è¨­å®ƒå¯èƒ½æ˜¯å‡ºå£
                    // ä½†æ›´æº–ç¢ºçš„æ˜¯æŠ“å–"é›¢é–‹åœ‹é“"çš„é‚£ä¸€åˆ»
                } else {
                    // --- é›¢é–‹åœ‹é“ ---
                    if (isOnHighway) {
                        isOnHighway = false;
                        // å‰›é›¢é–‹åœ‹é“çš„é‚£ä¸€æ­¥ï¼Œé€šå¸¸åŒ…å«"Take exit..."æˆ–"å‰å¾€..."
                        exitInstruction = cleanInstruction;
                    }
                }
            });

            // é¡¯ç¤ºçµæœ
            const resultDiv = document.getElementById("analysis-result");
            resultDiv.style.display = "block";

            let highwayHtml = "";
            let highwayKm = (highwayDistanceVal / 1000).toFixed(1);

            if (highwayDistanceVal > 0) {
                // è™•ç†é¡¯ç¤ºæ–‡å­—ï¼Œè‹¥å¤ªé•·å¯ä»¥æˆªæ–·
                const entryText = entryInstruction || "èµ·é»å³åœ¨é«˜é€Ÿå…¬è·¯ä¸Š";
                const exitText = exitInstruction || "çµ‚é»ä»åœ¨é«˜é€Ÿå…¬è·¯ä¸Š";

                highwayHtml = `
                    <div class="result-grid">
                        <div class="result-item">
                            <div class="result-label">ğŸ å…¨ç¨‹ç¸½è·é›¢</div>
                            <div class="result-value">${totalDistanceText}</div>
                        </div>
                         <div class="result-item" style="background:#e8f5e9;">
                            <div class="result-label">ğŸ›£ï¸ åœ‹é“/é«˜æ¶é‡Œç¨‹</div>
                            <div class="result-value highlight">${highwayKm} km</div>
                        </div>
                    </div>

                    <div class="ic-info">
                        <div class="ic-step">
                            <span class="ic-icon">â¬†ï¸ ä¸Š</span>
                            <span class="ic-text"><strong>é€²å…¥é»/äº¤æµé“ï¼š</strong><br>${entryText}</span>
                        </div>
                        <div class="ic-step">
                            <span class="ic-icon">â¬‡ï¸ ä¸‹</span>
                            <span class="ic-text"><strong>é›¢é–‹é»/äº¤æµé“ï¼š</strong><br>${exitText}</span>
                        </div>
                    </div>
                `;
            } else {
                highwayHtml = `
                    <div class="result-grid">
                        <div class="result-item">
                            <div class="result-label">ğŸ å…¨ç¨‹ç¸½è·é›¢</div>
                            <div class="result-value">${totalDistanceText}</div>
                        </div>
                         <div class="result-item">
                            <div class="result-label">ğŸ›£ï¸ é“è·¯é¡å‹</div>
                            <div class="result-value">å¹³é¢é“è·¯ (ç„¡åœ‹é“)</div>
                        </div>
                    </div>
                `;
            }

            resultDiv.innerHTML = `<h4>ğŸ“Š è·¯ç·šåˆ†æè©³æƒ…</h4>${highwayHtml}`;
        }

        window.onload = initMap;
    </script>
</body>
</html>
