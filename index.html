<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>åœ‹é“é‡Œç¨‹ã€å¹³å‡è·é›¢èˆ‡è½‰æ›é»è¨ˆç®—å™¨</title>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; padding: 20px; max-width: 900px; margin: 0 auto; background-color: #f4f4f4; }
        h2 { text-align: center; color: #333; }
        
        .input-group { margin-bottom: 15px; display: flex; gap: 10px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        input { padding: 12px; flex: 1; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; }
        button { padding: 10px 25px; background-color: #007bff; color: white; border: none; cursor: pointer; border-radius: 4px; font-size: 16px; font-weight: bold; }
        button:hover { background-color: #0056b3; }
        
        /* ç‰ˆé¢é…ç½® */
        #container { display: flex; gap: 20px; height: 500px; margin-top: 20px; }
        #selection-panel { width: 35%; overflow-y: auto; background: white; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); padding: 10px; }
        #map { width: 65%; background-color: #eee; height: 100%; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* è·¯ç·šæŒ‰éˆ•æ¨£å¼ */
        .route-btn { display: block; width: 100%; padding: 12px; margin-bottom: 8px; background: #fff; border: 1px solid #ddd; text-align: left; cursor: pointer; border-radius: 5px; transition: all 0.2s; }
        .route-btn:hover { background: #f0f0f0; border-color: #aaa; }
        .route-btn.active { background: #e8f0fe; border-color: #007bff; color: #0056b3; border-left: 5px solid #007bff; }

        /* çµ±è¨ˆè³‡è¨Šå€å¡Š */
        .stats-box { background: #e3f2fd; padding: 12px; border-radius: 6px; margin-bottom: 15px; border: 1px solid #bbdefb; font-size: 0.95em; color: #0d47a1; }
        .stats-highlight { color: #d32f2f; font-weight: bold; font-size: 1.1em; }

        /* åˆ†æçµæœå€å¡Š */
        #analysis-result { margin-top: 20px; padding: 20px; background: #fff; border-left: 6px solid #28a745; display: none; border-radius: 5px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .result-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px; }
        .result-item { background: #f9f9f9; padding: 10px; border-radius: 5px; }
        .result-label { font-size: 0.9em; color: #666; font-weight: bold; }
        .result-value { font-size: 1.1em; color: #333; margin-top: 5px; }
        .highlight { color: #d9534f; font-weight: bold; font-size: 1.2em; }
        
        /* äº¤æµé“èˆ‡è½‰æ›é»è³‡è¨Šæ¨£å¼ */
        .ic-info { margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px; }
        .ic-step { display: flex; align-items: flex-start; margin-bottom: 12px; }
        .ic-icon { min-width: 30px; color: #28a745; font-weight: bold; margin-right: 8px; font-size: 1.1em; }
        .ic-text { color: #555; line-height: 1.5; }
        
        /* è½‰æ›é»åˆ—è¡¨æ¨£å¼ */
        .transfer-list { margin-top: 5px; padding-left: 10px; border-left: 3px solid #ffc107; background: #fffbf0; padding: 10px; border-radius: 0 5px 5px 0; }
        .transfer-item { margin-bottom: 5px; font-size: 0.95em; color: #444; }
        .transfer-arrow { color: #f57c00; font-weight: bold; padding: 0 5px; }
    </style>
</head>
<body>

    <h2>ğŸš— åœ‹é“é‡Œç¨‹ã€å¹³å‡è·é›¢èˆ‡è½‰æ›é»è¨ˆç®—å™¨</h2>
    
    <div class="input-group">
        <input type="text" id="start" placeholder="è«‹è¼¸å…¥èµ·é» (ä¾‹å¦‚: å°åŒ—101)">
        <input type="text" id="end" placeholder="è«‹è¼¸å…¥çµ‚é» (ä¾‹å¦‚: é«˜é›„å·¦ç‡Ÿé«˜éµ)">
        <button onclick="calculateRoute()">æŸ¥è©¢è·¯ç·š</button>
    </div>

    <div id="analysis-result"></div>

    <div id="container">
        <div id="selection-panel">
            <p style="color:#666; text-align:center; margin-top: 20px;">è«‹å…ˆè¼¸å…¥åœ°é»ä¸¦æŸ¥è©¢...</p>
        </div>
        <div id="map"></div>
    </div>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCQsMxnmE1-3YCotbwGKkDhHiaPln8KwIQ&libraries=places"></script>

    <script>
        let map, directionsService, directionsRenderer;
        let allRoutes = [];

        function initMap() {
            const taiwan = { lat: 23.6978, lng: 120.9605 };
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 7,
                center: taiwan,
                mapTypeControl: false,
                streetViewControl: false
            });
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer();
            directionsRenderer.setMap(map);

            setupAutocomplete("start");
            setupAutocomplete("end");
        }

        function setupAutocomplete(elementId) {
            const input = document.getElementById(elementId);
            const options = {
                componentRestrictions: { country: "tw" },
                fields: ["formatted_address", "geometry", "name"],
            };
            new google.maps.places.Autocomplete(input, options);
        }

        function calculateRoute() {
            const start = document.getElementById("start").value;
            const end = document.getElementById("end").value;

            if (!start || !end) {
                alert("è«‹è¼¸å…¥èµ·é»å’Œçµ‚é»ï¼");
                return;
            }

            const request = {
                origin: start,
                destination: end,
                travelMode: 'DRIVING',
                provideRouteAlternatives: true,
                drivingOptions: {
                    departureTime: new Date(),
                    trafficModel: 'bestguess'
                }
            };

            directionsService.route(request, function(result, status) {
                if (status == 'OK') {
                    allRoutes = result.routes;
                    renderRouteList(result.routes);
                    selectRoute(0, result);
                } else {
                    handleError(status);
                }
            });
        }

        function handleError(status) {
            if (status === 'NOT_FOUND') alert('æ‰¾ä¸åˆ°åœ°é»ï¼Œè«‹å˜—è©¦è¼¸å…¥å®Œæ•´åœ°å€ã€‚');
            else if (status === 'ZERO_RESULTS') alert('ç„¡æ³•è¦åŠƒé–‹è»Šè·¯ç·šã€‚');
            else alert('æŸ¥è©¢å¤±æ•—: ' + status);
        }

        function renderRouteList(routes) {
            const panel = document.getElementById("selection-panel");
            
            // æ—¢æœ‰é‚è¼¯ï¼šè¨ˆç®—æœ€è¿‘èˆ‡æœ€é çš„å¹³å‡å€¼
            let minDistance = Infinity;
            let maxDistance = -Infinity;

            routes.forEach(route => {
                const val = route.legs[0].distance.value; 
                if (val < minDistance) minDistance = val;
                if (val > maxDistance) maxDistance = val;
            });

            const avgKm = ((minDistance + maxDistance) / 2 / 1000).toFixed(1);
            const minKm = (minDistance / 1000).toFixed(1);
            const maxKm = (maxDistance / 1000).toFixed(1);

            let htmlContent = `<h3 style='margin-top:0; padding-bottom:10px; border-bottom:1px solid #eee;'>å»ºè­°è·¯ç·š</h3>`;
            
            if (routes.length > 0) {
                htmlContent += `
                    <div class="stats-box">
                        <div style="margin-bottom:5px;">ğŸ“Š <strong>è·é›¢å€é–“åˆ†æ</strong></div>
                        <div style="font-size:0.9em; color:#555;">æœ€çŸ­: ${minKm} km / æœ€é•·: ${maxKm} km</div>
                        <div style="margin-top:5px;">
                            (æœ€é +æœ€è¿‘) å¹³å‡è·é›¢ï¼š<br>
                            <span class="stats-highlight">${avgKm} å…¬é‡Œ</span>
                        </div>
                    </div>
                `;
            }

            panel.innerHTML = htmlContent;

            routes.forEach((route, index) => {
                const summary = route.summary; 
                const distance = route.legs[0].distance.text;
                const duration = route.legs[0].duration.text;

                const btn = document.createElement("button");
                btn.className = "route-btn";
                btn.innerHTML = `
                    <div style="font-weight:bold; font-size:1.1em;">è·¯ç·š ${index + 1}</div>
                    <div style="color:#666; font-size:0.9em;">${summary}</div>
                    <div style="margin-top:5px;">ç¸½é•·: ${distance} | æ™‚é–“: ${duration}</div>
                `;
                btn.onclick = () => selectRoute(index);
                panel.appendChild(btn);
            });
        }

        function selectRoute(index, resultObj = null) {
            if (!resultObj) {
                directionsRenderer.setDirections({routes: allRoutes, request: {}, status: "OK"}); 
            } else {
                directionsRenderer.setDirections(resultObj);
            }
            directionsRenderer.setRouteIndex(index);
            
            document.querySelectorAll(".route-btn").forEach((btn, i) => {
                btn.classList.toggle("active", i === index);
            });

            analyzeHighwayDetails(allRoutes[index]);
        }

        function analyzeHighwayDetails(route) {
            const leg = route.legs[0];
            const steps = leg.steps;
            
            const totalDistanceText = leg.distance.text;
            let highwayDistanceVal = 0;
            let entryInstruction = null;
            let exitInstruction = null;
            let isOnHighway = false;

            // ç”¨æ–¼è¿½è¹¤åœ‹é“è½‰æ›
            let lastHighwayName = null;
            let transfers = []; 

            // å®šç¾©åœ‹é“é—œéµå­— Regex
            const highwayRegex = /(åœ‹é“|é«˜é€Ÿå…¬è·¯|Freeway|Expressway)/i; 
            // æ•æ‰åœ‹é“åç¨± Regex (ä¾‹å¦‚ï¼šåœ‹é“1è™Ÿ, åœ‹é“3è™Ÿ, National Fwy 1)
            const highwayNameRegex = /(åœ‹é“\d+(?:ç”²|ä¹™)?è™Ÿ?|National Fwy \d+)/i;

            steps.forEach((step, i) => {
                const rawInstruction = step.instructions;
                const cleanInstruction = rawInstruction.replace(/<[^>]*>/g, ""); 
                
                if (highwayRegex.test(cleanInstruction)) {
                    // --- ç‹€æ…‹ï¼šåœ¨é«˜é€Ÿå…¬è·¯ä¸Š ---
                    if (!isOnHighway) {
                        isOnHighway = true;
                        entryInstruction = cleanInstruction; // è¨˜éŒ„ä¸Šäº¤æµé“
                    }
                    
                    highwayDistanceVal += step.distance.value;

                    // â˜… æ ¸å¿ƒä¿®æ”¹ï¼šåµæ¸¬åœ‹é“è½‰æ› â˜…
                    const nameMatch = cleanInstruction.match(highwayNameRegex);
                    if (nameMatch) {
                        const currentName = nameMatch[0];
                        
                        // å¦‚æœå·²ç¶“æœ‰ç´€éŒ„ä¸Šä¸€æ¢åœ‹é“ï¼Œä¸”åç¨±ä¸åŒï¼Œå‰‡ç‚ºè½‰æ›é»
                        if (lastHighwayName && lastHighwayName !== currentName) {
                            transfers.push({
                                from: lastHighwayName,
                                to: currentName,
                                // å˜—è©¦æŠ“å–æ¯”è¼ƒæ˜“è®€çš„æŒ‡ç¤ºï¼Œå¦‚æœç•¶å‰é€™æ­¥æ˜¯æŒ‡ç¤º"å‰å¾€XX"ï¼Œé€šå¸¸å°±æ˜¯è½‰æ›é»
                                note: cleanInstruction 
                            });
                        }
                        lastHighwayName = currentName;
                    }

                } else {
                    // --- ç‹€æ…‹ï¼šé›¢é–‹é«˜é€Ÿå…¬è·¯ ---
                    if (isOnHighway) {
                        isOnHighway = false;
                        exitInstruction = cleanInstruction; // è¨˜éŒ„ä¸‹äº¤æµé“
                    }
                }
            });

            renderAnalysisResult(totalDistanceText, highwayDistanceVal, entryInstruction, exitInstruction, transfers);
        }

        function renderAnalysisResult(totalDist, highwayVal, entry, exit, transfers) {
            const resultDiv = document.getElementById("analysis-result");
            resultDiv.style.display = "block";

            let highwayKm = (highwayVal / 1000).toFixed(1);

            if (highwayVal > 0) {
                const entryText = entry || "èµ·é»å³åœ¨é«˜é€Ÿå…¬è·¯ä¸Š";
                const exitText = exit || "çµ‚é»ä»åœ¨é«˜é€Ÿå…¬è·¯ä¸Š";
                
                // ç”¢ç”Ÿè½‰æ›é» HTML
                let transferHtml = "";
                if (transfers.length > 0) {
                    transferHtml = `<div class="ic-step"><span class="ic-icon">ğŸ”€</span><div class="ic-text"><strong>åœ‹é“è½‰æ›æ˜ç´°ï¼š</strong><div class="transfer-list">`;
                    transfers.forEach(t => {
                        transferHtml += `<div class="transfer-item">${t.from} <span class="transfer-arrow">â”</span> ${t.to}</div>`;
                    });
                    transferHtml += `</div></div></div>`;
                }

                resultDiv.innerHTML = `
                    <h4>ğŸ“Š è·¯ç·šåˆ†æè©³æƒ…</h4>
                    <div class="result-grid">
                        <div class="result-item">
                            <div class="result-label">ğŸ å…¨ç¨‹ç¸½è·é›¢</div>
                            <div class="result-value">${totalDist}</div>
                        </div>
                         <div class="result-item" style="background:#e8f5e9;">
                            <div class="result-label">ğŸ›£ï¸ åœ‹é“/é«˜æ¶é‡Œç¨‹</div>
                            <div class="result-value highlight">${highwayKm} km</div>
                        </div>
                    </div>

                    <div class="ic-info">
                        <div class="ic-step">
                            <span class="ic-icon">â¬†ï¸</span>
                            <span class="ic-text"><strong>é€²å…¥é»/äº¤æµé“ï¼š</strong><br>${entryText}</span>
                        </div>
                        
                        ${transferHtml} <div class="ic-step">
                            <span class="ic-icon">â¬‡ï¸</span>
                            <span class="ic-text"><strong>é›¢é–‹é»/äº¤æµé“ï¼š</strong><br>${exitText}</span>
                        </div>
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <h4>ğŸ“Š è·¯ç·šåˆ†æè©³æƒ…</h4>
                    <div class="result-grid">
                        <div class="result-item">
                            <div class="result-label">ğŸ å…¨ç¨‹ç¸½è·é›¢</div>
                            <div class="result-value">${totalDist}</div>
                        </div>
                         <div class="result-item">
                            <div class="result-label">ğŸ›£ï¸ é“è·¯é¡å‹</div>
                            <div class="result-value">å¹³é¢é“è·¯ (ç„¡åœ‹é“)</div>
                        </div>
                    </div>
                `;
            }
        }

        window.onload = initMap;
    </script>
</body>
</html>
