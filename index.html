<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>åœ‹é“é‡Œç¨‹è¨ˆç®—å™¨</title>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; padding: 20px; max-width: 900px; margin: 0 auto; }
        .input-group { margin-bottom: 15px; display: flex; gap: 10px; }
        input { padding: 10px; flex: 1; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 10px 20px; background-color: #28a745; color: white; border: none; cursor: pointer; border-radius: 4px; }
        button:hover { background-color: #218838; }
        
        /* ç‰ˆé¢é…ç½® */
        #container { display: flex; gap: 20px; height: 500px; margin-top: 20px; }
        #selection-panel { width: 30%; overflow-y: auto; border-right: 1px solid #eee; padding-right: 10px; }
        #map { width: 70%; background-color: #eee; height: 100%; border-radius: 4px; }

        /* è·¯ç·šæŒ‰éˆ•æ¨£å¼ */
        .route-btn { display: block; width: 100%; padding: 15px; margin-bottom: 10px; background: #f8f9fa; border: 1px solid #ddd; text-align: left; cursor: pointer; border-radius: 5px; }
        .route-btn:hover { background: #e2e6ea; }
        .route-btn.active { background: #d4edda; border-color: #c3e6cb; }

        /* åˆ†æçµæœå€å¡Š */
        #analysis-result { margin-top: 20px; padding: 15px; background: #fff3cd; border: 1px solid #ffeeba; display: none; border-radius: 5px; }
        .highlight { color: #d9534f; font-weight: bold; }
    </style>
</head>
<body>

    <h2>ğŸš— åœ‹é“é‡Œç¨‹èˆ‡äº¤æµé“æŸ¥è©¢</h2>
    
    <div class="input-group">
        <input type="text" id="start" placeholder="è«‹è¼¸å…¥èµ·é» (ä¾‹å¦‚: å°åŒ—101)">
        <input type="text" id="end" placeholder="è«‹è¼¸å…¥çµ‚é» (ä¾‹å¦‚: å°ä¸­ç«è»Šç«™)">
        <button onclick="calculateRoute()">æŸ¥è©¢è·¯ç·š</button>
    </div>

    <div id="analysis-result"></div>

    <div id="container">
        <div id="selection-panel">
            <p style="color:#666;">è«‹å…ˆè¼¸å…¥åœ°é»ä¸¦æŸ¥è©¢...</p>
        </div>
        <div id="map"></div>
    </div>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCQsMxnmE1-3YCotbwGKkDhHiaPln8KwIQ&libraries=places"></script>

    <script>
        let map, directionsService, directionsRenderer;
        let allRoutes = [];

        function initMap() {
            // 1. åˆå§‹åŒ–åœ°åœ–
            const taiwan = { lat: 23.6978, lng: 120.9605 };
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 7,
                center: taiwan
            });
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer();
            directionsRenderer.setMap(map);

            // 2. â˜… æ–°å¢ï¼šå•Ÿå‹•è¼¸å…¥æ¡†çš„è‡ªå‹•å®ŒæˆåŠŸèƒ½
            setupAutocomplete("start");
            setupAutocomplete("end");
        }

        // è¨­å®šè‡ªå‹•å®Œæˆçš„è¼”åŠ©å‡½å¼
        function setupAutocomplete(elementId) {
            const input = document.getElementById(elementId);
            const options = {
                componentRestrictions: { country: "tw" }, // é™åˆ¶åªæœå°‹å°ç£ç¯„åœ
                fields: ["formatted_address", "geometry", "name"], // åªæŠ“å–éœ€è¦çš„æ¬„ä½ä»¥ç¯€çœæˆæœ¬
            };
            
            const autocomplete = new google.maps.places.Autocomplete(input, options);
            
            // ç•¶ä½¿ç”¨è€…å¾é¸å–®é¸å–åœ°é»å¾Œï¼Œä¸éœ€è¦åšç‰¹åˆ¥çš„äº‹ï¼ŒGoogle æœƒè‡ªå‹•æŠŠå®Œæ•´åœ°å€å¡«å…¥ input
            // ä½†æˆ‘å€‘å¯ä»¥é¸æ“‡è®“åœ°åœ–è‡ªå‹•è·³è½‰åˆ°è©²é» (éå¿…è¦ï¼Œçœ‹éœ€æ±‚)
            autocomplete.addListener("place_changed", () => {
                const place = autocomplete.getPlace();
                if (!place.geometry || !place.geometry.location) {
                    window.alert("æ‰¾ä¸åˆ°è©²åœ°é»çš„è©³ç´°è³‡è¨Š: '" + place.name + "'");
                    return;
                }
            });
        }

        function calculateRoute() {
            const start = document.getElementById("start").value;
            const end = document.getElementById("end").value;

            if (!start || !end) {
                alert("è«‹è¼¸å…¥èµ·é»å’Œçµ‚é»ï¼");
                return;
            }

            const request = {
                origin: start,
                destination: end,
                travelMode: 'DRIVING',
                provideRouteAlternatives: true,
                drivingOptions: {
                    departureTime: new Date(),
                    trafficModel: 'bestguess'
                }
            };

            directionsService.route(request, function(result, status) {
                if (status == 'OK') {
                    allRoutes = result.routes;
                    renderRouteList(result.routes);
                    selectRoute(0, result);
                } else {
                    // é€™è£¡å¯ä»¥é¡¯ç¤ºæ›´å‹å–„çš„éŒ¯èª¤è¨Šæ¯
                    if (status === 'NOT_FOUND') {
                        alert('æ‰¾ä¸åˆ°æ‚¨è¼¸å…¥çš„åœ°é»ï¼Œè«‹å˜—è©¦è¼¸å…¥å®Œæ•´åœ°å€æˆ–ä½¿ç”¨ä¸‹æ‹‰é¸å–®é¸æ“‡åœ°é»ã€‚');
                    } else if (status === 'ZERO_RESULTS') {
                        alert('é€™å…©åœ°ä¹‹é–“ç„¡æ³•è¦åŠƒé–‹è»Šè·¯ç·šï¼ˆå¯èƒ½éš”æµ·æˆ–ç„¡è·¯å¯é€šï¼‰ã€‚');
                    } else {
                        alert('è·¯å¾‘æœå°‹å¤±æ•—: ' + status);
                    }
                }
            });
        }

        // --- ä»¥ä¸‹ç‚ºåŸæœ‰çš„é¡¯ç¤ºé‚è¼¯ï¼Œä¿æŒä¸è®Š ---

        function renderRouteList(routes) {
            const panel = document.getElementById("selection-panel");
            panel.innerHTML = "<h3>è«‹é¸æ“‡è·¯ç·šï¼š</h3>";

            routes.forEach((route, index) => {
                const summary = route.summary; 
                const distance = route.legs[0].distance.text;
                const duration = route.legs[0].duration.text;

                const btn = document.createElement("button");
                btn.className = "route-btn";
                btn.innerHTML = `<strong>è·¯ç·š ${index + 1} (${summary})</strong><br>ç¸½é•·: ${distance} / æ™‚é–“: ${duration}`;
                btn.onclick = () => selectRoute(index);
                panel.appendChild(btn);
            });
        }

        function selectRoute(index, resultObj = null) {
            if (!resultObj) {
                directionsRenderer.setDirections({routes: allRoutes, request: {}, status: "OK"}); 
            } else {
                directionsRenderer.setDirections(resultObj);
            }
            directionsRenderer.setRouteIndex(index);
            
            document.querySelectorAll(".route-btn").forEach((btn, i) => {
                btn.classList.toggle("active", i === index);
            });

            analyzeHighwayDetails(allRoutes[index]);
        }

        function analyzeHighwayDetails(route) {
            const steps = route.legs[0].steps;
            let highwayDistance = 0;
            let entryPoint = null;
            let exitPoint = null;
            let isOnHighway = false;

            // ç¨å¾®å¢å¼· Regexï¼Œé¿å…æ¼æŠ“ "National Freeway"
            const highwayRegex = /(åœ‹é“|é«˜é€Ÿå…¬è·¯|Freeway)/i; 

            steps.forEach((step, i) => {
                const instructions = step.instructions.replace(/<[^>]*>/g, ""); 
                
                if (highwayRegex.test(instructions)) {
                    if (!isOnHighway) {
                        isOnHighway = true;
                        entryPoint = instructions; 
                    }
                    highwayDistance += step.distance.value;
                } else {
                    if (isOnHighway) {
                        isOnHighway = false;
                        exitPoint = instructions;
                    }
                }
            });

            const resultDiv = document.getElementById("analysis-result");
            
            if (highwayDistance > 0) {
                resultDiv.style.display = "block";
                const km = (highwayDistance / 1000).toFixed(1);
                
                resultDiv.innerHTML = `
                    <h4>ğŸ›£ï¸ é«˜é€Ÿå…¬è·¯åˆ†æçµæœ</h4>
                    <p>æ­¤è·¯ç·šç¶“éé«˜é€Ÿå…¬è·¯è·¯æ®µï¼š<span class="highlight">${km} å…¬é‡Œ</span></p>
                    <ul>
                        <li><strong>é€²å…¥é»æŒ‡ç¤ºï¼š</strong> ${entryPoint || "èµ·é»å³åœ¨é«˜é€Ÿå…¬è·¯ä¸Š"}</li>
                        <li><strong>é›¢é–‹é»æŒ‡ç¤ºï¼š</strong> ${exitPoint || "çµ‚é»ä»åœ¨é«˜é€Ÿå…¬è·¯ä¸Š"}</li>
                    </ul>
                    <small>* è¨»ï¼šæ­¤ç‚ºåœ°åœ–è·¯å¾‘æ¨ç®—ï¼Œèˆ‡å¯¦éš› eTag æ”¶è²»é–€æ¶é‡Œç¨‹å¯èƒ½ä¸åŒã€‚</small>
                `;
            } else {
                resultDiv.style.display = "block";
                resultDiv.innerHTML = "<h4>ğŸ›£ï¸ ä¸€èˆ¬é“è·¯</h4><p>æ­¤è·¯ç·šæœªåµæ¸¬åˆ°ä¸»è¦è¡Œé§›åœ‹é“ã€‚</p>";
            }
        }

        window.onload = initMap;
    </script>
</body>
</html>
