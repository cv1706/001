<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>åœ‹é“é‡Œç¨‹è¨ˆç®—å™¨</title>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; padding: 20px; max-width: 900px; margin: 0 auto; }
        .input-group { margin-bottom: 15px; display: flex; gap: 10px; }
        input { padding: 10px; flex: 1; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 10px 20px; background-color: #28a745; color: white; border: none; cursor: pointer; border-radius: 4px; }
        button:hover { background-color: #218838; }
        
        /* ç‰ˆé¢é…ç½® */
        #container { display: flex; gap: 20px; height: 500px; margin-top: 20px; }
        #selection-panel { width: 30%; overflow-y: auto; border-right: 1px solid #eee; padding-right: 10px; }
        #map { width: 70%; background-color: #eee; height: 100%; border-radius: 4px; }

        /* è·¯ç·šæŒ‰éˆ•æ¨£å¼ */
        .route-btn { display: block; width: 100%; padding: 15px; margin-bottom: 10px; background: #f8f9fa; border: 1px solid #ddd; text-align: left; cursor: pointer; border-radius: 5px; }
        .route-btn:hover { background: #e2e6ea; }
        .route-btn.active { background: #d4edda; border-color: #c3e6cb; }

        /* åˆ†æçµæœå€å¡Š */
        #analysis-result { margin-top: 20px; padding: 15px; background: #fff3cd; border: 1px solid #ffeeba; display: none; border-radius: 5px; }
        .highlight { color: #d9534f; font-weight: bold; }
    </style>
</head>
<body>

    <h2>ğŸš— åœ‹é“é‡Œç¨‹èˆ‡äº¤æµé“æŸ¥è©¢</h2>
    
    <div class="input-group">
        <input type="text" id="start" placeholder="è«‹è¼¸å…¥èµ·é» (ä¾‹å¦‚: å°åŒ—101)">
        <input type="text" id="end" placeholder="è«‹è¼¸å…¥çµ‚é» (ä¾‹å¦‚: å°ä¸­ç«è»Šç«™)">
        <button onclick="calculateRoute()">æŸ¥è©¢è·¯ç·š</button>
    </div>

    <div id="analysis-result"></div>

    <div id="container">
        <div id="selection-panel">
            <p style="color:#666;">è«‹å…ˆè¼¸å…¥åœ°é»ä¸¦æŸ¥è©¢...</p>
        </div>
        <div id="map"></div>
    </div>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCQsMxnmE1-3YCotbwGKkDhHiaPln8KwIQ&libraries=places"></script>

    <script>
        let map, directionsService, directionsRenderer;
        let allRoutes = []; // å„²å­˜ API å›å‚³çš„æ‰€æœ‰è·¯ç·š

        function initMap() {
            // åˆå§‹åŒ–åœ°åœ–ä¸­å¿ƒ (å°ç£)
            const taiwan = { lat: 23.6978, lng: 120.9605 };
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 7,
                center: taiwan
            });
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer();
            directionsRenderer.setMap(map);
        }

        function calculateRoute() {
            const start = document.getElementById("start").value;
            const end = document.getElementById("end").value;

            if (!start || !end) {
                alert("è«‹è¼¸å…¥èµ·é»å’Œçµ‚é»ï¼");
                return;
            }

            const request = {
                origin: start,
                destination: end,
                travelMode: 'DRIVING',
                provideRouteAlternatives: true, // é—œéµï¼šå…è¨±å›å‚³å¤šæ¢è·¯ç·š
                drivingOptions: {
                    departureTime: new Date(), // è€ƒæ…®å³æ™‚è·¯æ³ (éƒ¨åˆ†åœ°å€æœ‰æ•ˆ)
                    trafficModel: 'bestguess'
                }
            };

            directionsService.route(request, function(result, status) {
                if (status == 'OK') {
                    allRoutes = result.routes; // å­˜ä¸‹ä¾†ä¾›å¾ŒçºŒé¸æ“‡ç”¨
                    renderRouteList(result.routes);
                    
                    // é è¨­é¡¯ç¤ºç¬¬ä¸€æ¢è·¯ç·š
                    selectRoute(0, result);
                } else {
                    alert('è·¯å¾‘æœå°‹å¤±æ•—: ' + status);
                }
            });
        }

        // æ¸²æŸ“å·¦å´çš„è·¯ç·šé¸æ“‡æŒ‰éˆ•
        function renderRouteList(routes) {
            const panel = document.getElementById("selection-panel");
            panel.innerHTML = "<h3>è«‹é¸æ“‡è·¯ç·šï¼š</h3>";

            routes.forEach((route, index) => {
                const summary = route.summary; // ä¾‹å¦‚ "åœ‹é“1è™Ÿ"
                const distance = route.legs[0].distance.text;
                const duration = route.legs[0].duration.text;

                const btn = document.createElement("button");
                btn.className = "route-btn";
                btn.innerHTML = `<strong>è·¯ç·š ${index + 1} (${summary})</strong><br>ç¸½é•·: ${distance} / æ™‚é–“: ${duration}`;
                btn.onclick = () => selectRoute(index);
                panel.appendChild(btn);
            });
        }

        // ç•¶ä½¿ç”¨è€…é¸æ“‡æŸä¸€æ¢è·¯ç·šæ™‚
        function selectRoute(index, resultObj = null) {
            // å¦‚æœæ²’æœ‰å‚³å…¥ resultObjï¼Œä»£è¡¨æ˜¯å¾æŒ‰éˆ•é»æ“Šçš„ï¼Œéœ€è¦é‡æ–°è¨­å®š renderer
            if (!resultObj) {
                // é€™è£¡æˆ‘å€‘éœ€è¦é‡æ–°å»ºæ§‹ä¸€å€‹åªåŒ…å«è©²è·¯ç·šçš„ Result ç‰©ä»¶çµ¦ Renderer 
                // ä½†ç°¡å–®çš„åšæ³•æ˜¯ç›´æ¥è¨­å®š routeIndex (DirectionsRenderer æ”¯æ´)
                directionsRenderer.setDirections({routes: allRoutes, request: {}, status: "OK"}); 
            } else {
                directionsRenderer.setDirections(resultObj);
            }
            
            directionsRenderer.setRouteIndex(index); // åˆ‡æ›åœ°åœ–é¡¯ç¤ºçš„è·¯ç·š

            // è¦–è¦ºä¸Šçš„æŒ‰éˆ•é¸å–æ•ˆæœ
            document.querySelectorAll(".route-btn").forEach((btn, i) => {
                btn.classList.toggle("active", i === index);
            });

            // â˜… åŸ·è¡Œæ ¸å¿ƒé‚è¼¯ï¼šåˆ†æè©²è·¯ç·šçš„é«˜é€Ÿå…¬è·¯æ®µ
            analyzeHighwayDetails(allRoutes[index]);
        }

        // æ ¸å¿ƒé‚è¼¯ï¼šè§£æ Steps æ‰¾å‡ºä¸Šä¸‹äº¤æµé“èˆ‡é‡Œç¨‹
        function analyzeHighwayDetails(route) {
            const steps = route.legs[0].steps;
            let highwayDistance = 0;
            let entryPoint = null;
            let exitPoint = null;
            let isOnHighway = false;
            let highwayName = "";

            // ç”¨ Regex ç°¡å–®åˆ¤æ–·é—œéµå­— (åœ‹é“ã€é«˜é€Ÿå…¬è·¯)
            const highwayRegex = /(åœ‹é“|é«˜é€Ÿå…¬è·¯|Freeway)/;

            steps.forEach((step, i) => {
                // å»é™¤ HTMLæ¨™ç±¤å–å¾—ç´”æ–‡å­—æŒ‡ç¤º (ä¾‹å¦‚: "ä½µå…¥<b>åœ‹é“ä¸€è™Ÿ</b>")
                const instructions = step.instructions.replace(/<[^>]*>/g, ""); 
                
                // åˆ¤æ–·æ­¤æ­¥é©Ÿæ˜¯å¦åœ¨é«˜é€Ÿå…¬è·¯ä¸Š
                if (highwayRegex.test(instructions)) {
                    if (!isOnHighway) {
                        // å‰›é€²å…¥é«˜é€Ÿå…¬è·¯ (ç´€éŒ„é€²å…¥é»)
                        isOnHighway = true;
                        // é€šå¸¸é€²å…¥é»çš„æŒ‡ç¤ºæ˜¯ "ä½µå…¥åœ‹é“Xè™Ÿ"ï¼Œé€™è£¡æˆ‘å€‘æŠ“å–è©²æ­¥é©Ÿçš„èµ·é»ä½ç½®æˆ–å‰ä¸€å€‹æ­¥é©Ÿçš„æŒ‡ç¤º
                        entryPoint = instructions; 
                        highwayName = instructions; // æš«å­˜è·¯å
                    }
                    
                    // ç´¯åŠ é‡Œç¨‹
                    highwayDistance += step.distance.value;
                    
                    // éš¨æ™‚æ›´æ–°æœ€å¾Œä¸€å€‹é»ï¼Œç•¶è¿´åœˆçµæŸæˆ–é›¢é–‹é«˜é€Ÿå…¬è·¯æ™‚ï¼Œé€™å€‹é»å°±æ˜¯é›¢é–‹é»
                    // step.instructions åœ¨é«˜é€Ÿå…¬è·¯ä¸Šé€šå¸¸æ˜¯ "ç¹¼çºŒé–‹åœ¨åœ‹é“Xè™Ÿä¸Š"ï¼Œç›´åˆ°ä¸‹ä¸€å€‹ step æ˜¯ "ä¸‹å‡ºå£"
                } else {
                    // å¦‚æœä¹‹å‰åœ¨é«˜é€Ÿå…¬è·¯ä¸Šï¼Œç¾åœ¨ä¸åœ¨äº† -> ä»£è¡¨å‰›ä¸‹äº†äº¤æµé“
                    if (isOnHighway) {
                        isOnHighway = false;
                        exitPoint = instructions; // è¨˜éŒ„ "ä¸‹äº¤æµé“" çš„é‚£å€‹æŒ‡ä»¤ (ä¾‹å¦‚: "å‰å¾€æ–°ç«¹çš„å‡ºå£")
                    }
                }
            });

            // é¡¯ç¤ºçµæœ
            const resultDiv = document.getElementById("analysis-result");
            
            if (highwayDistance > 0) {
                resultDiv.style.display = "block";
                // å…¬å°ºè½‰å…¬é‡Œ
                const km = (highwayDistance / 1000).toFixed(1);
                
                resultDiv.innerHTML = `
                    <h4>ğŸ›£ï¸ é«˜é€Ÿå…¬è·¯åˆ†æçµæœ</h4>
                    <p>æ­¤è·¯ç·šç¶“éé«˜é€Ÿå…¬è·¯è·¯æ®µï¼š<span class="highlight">${km} å…¬é‡Œ</span></p>
                    <ul>
                        <li><strong>é€²å…¥é»æŒ‡ç¤ºï¼š</strong> ${entryPoint || "èµ·é»å³åœ¨é«˜é€Ÿå…¬è·¯ä¸Š"}</li>
                        <li><strong>é›¢é–‹é»æŒ‡ç¤ºï¼š</strong> ${exitPoint || "çµ‚é»ä»åœ¨é«˜é€Ÿå…¬è·¯ä¸Š"}</li>
                    </ul>
                    <small>* è¨»ï¼šæ­¤ç‚ºåœ°åœ–è·¯å¾‘æ¨ç®—ï¼Œèˆ‡å¯¦éš› eTag æ”¶è²»é–€æ¶é‡Œç¨‹å¯èƒ½ä¸åŒã€‚</small>
                `;
            } else {
                resultDiv.style.display = "block";
                resultDiv.innerHTML = "<h4>ğŸ›£ï¸ ä¸€èˆ¬é“è·¯</h4><p>æ­¤è·¯ç·šæœªåµæ¸¬åˆ°ä¸»è¦è¡Œé§›åœ‹é“ (æˆ–è·¯å¾‘éçŸ­)ã€‚</p>";
            }
        }

        // å•Ÿå‹•åœ°åœ–
        window.onload = initMap;

    </script>
</body>
</html>
